# Техническое видение MLOps проекта для развертывания ML-моделей

## Содержание

1. Технологии
2. Принцип разработки
3. Структура проекта
4. Архитектура проекта
5. Модель данных
6. Работа с ML моделью
7. Сценарии работы
8. Деплой
9. Подход к конфигурированию
10. Подход к логгированию

---

## Описание
Техническое видение для разработки MLOps сервиса развертывания модели обнаружения мошенничества в production среду с использованием REST API, контейнеризации и Kubernetes оркестрации.

---

## 1. Технологии

### Основные технологии
- **Python 3.11+** - основной язык разработки
- **FastAPI** - современный асинхронный веб-фреймворк для создания REST API
- **MLflow** - платформа для управления жизненным циклом ML моделей
- **MLflow** - загрузка и inference ML модели через PyFunc интерфейс

### Управление проектом и зависимостями
- **uv** - современный менеджер пакетов и виртуальных окружений Python
- **pytest** - фреймворк для тестирования
- **make** - автоматизация сборки, запуска и деплоя

### Инфраструктура
- **Docker** - контейнеризация для изоляции зависимостей
- **Kubernetes** - оркестрация контейнеров (локальный кластер kubeadm)
- **ArgoCD** - GitOps для автоматического деплоя в Kubernetes
- **GitHub Actions** - CI/CD пайплайн
- **Proxmox VE** - виртуализация инфраструктуры

## 2. Принцип разработки

### Методология разработки
- **MLOps подход** - автоматизация ML пайплайна от обучения до развертывания
- **Контейнерная архитектура** - изоляция зависимостей и портабельность
- **Микросервисный подход** - независимое развертывание компонентов

### Архитектурные принципы
- **API-First** - REST API как основной интерфейс взаимодействия
- **Stateless сервис** - отсутствие состояния между запросами
- **Принцип единственной ответственности** - каждый компонент выполняет одну задачу

### Качество кода
- **Чистый код** - понятные имена, комментарии, документация
- **Обработка ошибок** - корректная обработка исключений и валидация данных
- **Тестирование** - unit и integration тесты для критических компонентов

## 3. Структура проекта

### MLOps структура
```
/
├── src/
│   ├── api.py               # FastAPI REST сервис
│   ├── model_loader.py      # Загрузка и инициализация модели
│   ├── preprocessing.py     # Предобработка данных
│   └── prediction.py        # Логика предсказаний
# models/ - удалена, модель загружается напрямую в память из MLflow
├── tests/
│   ├── test_api.py         # Тесты API эндпоинтов
│   └── test_model.py       # Тесты модели
├── argocd/
│   ├── application.yaml    # ArgoCD Application
│   └── manifests/
│       ├── deployment.yaml # Kubernetes Deployment
│       ├── service.yaml    # Kubernetes Service
│       └── ingress.yaml    # Kubernetes Ingress
├── .github/
│   └── workflows/
│       └── ci-cd.yml       # GitHub Actions пайплайн
├── Dockerfile              # Контейнеризация
├── requirements.txt        # Python зависимости
├── Makefile               # Автоматизация задач
├── .env                   # Переменные окружения (не в Git)
```

## 4. Архитектура проекта

### Компоненты системы
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Client        │───►│   FastAPI       │───►│   ML Model      │
│ (HTTP Request)  │    │  (REST API)     │    │ (Fraud Detection│
└─────────────────┘    └─────────────────┘    └─────────────────┘
       │                        │                       │
   JSON Request ──────────► Validation ─────────► Prediction
       │                        │                       │
   JSON Response ◄─────────── Formatting ◄───────── Result
```

### Инфраструктурная архитектура (GitOps)
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   GitHub        │───►│   CI/CD         │───►│   ArgoCD        │───►│   Kubernetes    │
│  (Repository)   │    │ (GitHub Actions)│    │   (GitOps)      │    │   (Cluster)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
       │                        │                       │                       │
   Code Push ──────────────► Build & Test ─────► Git Commit ──────► Auto Deploy
       │                        │                       │                       │
   Webhook ◄───────────────── Docker Build ◄──── Pull Changes ◄──── Health Check
```

## 5. Модель данных

### Входные данные API
```python
{
    "transaction_id": "tx_12345",
    "amount": 150.50,
    "merchant_category": "grocery_stores",
    "hour": 14,
    "day_of_week": 2,
    "user_age": 35,
    "account_balance": 2500.00
}
```

### Выходные данные API
```python
{
    "transaction_id": "tx_12345",
    "is_fraud": false,
    "fraud_probability": 0.15,
    "confidence": 0.85,
    "model_version": "v1.2.3",
    "prediction_time": "2024-01-15T10:30:00Z"
}
```

## 6. Работа с ML моделью

### Подход к загрузке модели (Pure In-Memory)
1. **Загрузка ТОЛЬКО в память** - модель загружается из MLflow напрямую в оперативную память при старте сервиса
2. **Кэширование ТОЛЬКО в памяти** - модель остается в памяти для быстрых предсказаний (никаких файлов на диске)
3. **Простая стратегия** - при недоступности MLflow сервис не запускается (fail-fast)
4. **Версионирование** - поддержка различных версий модели через MLflow Model Registry

### Пример функции предсказания
```python
async def predict_fraud(transaction_data: dict) -> dict:
    # Предобработка данных
    features = preprocess_transaction(transaction_data)
    
    # Получение предсказания
    prediction = model.predict([features])[0]
    probability = model.predict_proba([features])[0]
    
    return {
        "is_fraud": bool(prediction),
        "fraud_probability": float(probability[1]),
        "confidence": float(max(probability))
    }
```

## 7. Сценарии работы

### Основные сценарии API
1. **Предсказание мошенничества** - анализ транзакции и возврат вероятности мошенничества
2. **Batch предсказания** - обработка множественных транзакций
3. **Health Check** - проверка состояния сервиса и модели

## 8. Деплой

### CI/CD Pipeline (GitOps)
1. **Тестирование** - запуск unit и integration тестов
2. **Сборка Docker образа** - контейнеризация приложения
3. **Публикация в Registry** - сохранение образа в container registry
4. **Обновление манифестов** - автоматическое обновление версии образа в Git
5. **ArgoCD синхронизация** - автоматический деплой через GitOps

### ArgoCD конфигурация
- **Application** - ArgoCD приложение для автоматической синхронизации
- **Source Repository** - Git репозиторий с Kubernetes манифестами
- **Target Cluster** - целевой Kubernetes кластер
- **Sync Policy** - политика автоматической синхронизации

### Kubernetes конфигурация
- **Deployment** - управление репликами сервиса
- **Service** - балансировка нагрузки между подами
- **Ingress** - внешний доступ к API
- **ConfigMap** - конфигурация приложения

## 9. Подход к конфигурированию

### Конфигурация через .env файл

Все конфигурационные параметры хранятся в `.env` файле:

- **MLflow** - настройки подключения к серверу и модели
- **S3/MinIO** - доступ к артефактам модели
- **API** - конфигурация FastAPI сервера
- **Model** - параметры кэширования и таймаутов

Пример конфигурации смотрите в `env-example` файле.